---
title: "MCMCTreeR"
author:
- Mark Puttick
- marknputtick@gmail.com
- University of Bath
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
toc: true
header-includes: \usepackage{float}
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

This is a guide for the R program [MCMCTreeR](https://github.com/PuttickMacroevolution). 

MCMCTreeR contains functions to set up analyses in the [MCMCtree](http://abacus.gene.ucl.ac.uk/software/paml.html) program. The functions here help users choose the best parameters to reflect age information for prior age distributions, visualise time priors, and produce output files ready to be used in MCMCtree. A seperate [vignette](https://github.com/PuttickMacroevolution/MCMCTreeR/blob/master/vignettes/MCMCtree_plot.pdf) is available to explain the plotting options for timescaled trees in MCMCTreeR

[MCMCtree](http://abacus.gene.ucl.ac.uk/software/paml.html) is a Bayesian program in the software PAML to estimate divergence times on fixed topologies using molecular data developed by Ziheng Yang. The program requires various inputs from the user: a phylogeny, molecular data, and selected model parameters. This guide does not include details about which time priors are most appropriate for the data, etc, so please see the [MCMCtree manual](http://abacus.gene.ucl.ac.uk/software/pamlDOC.pdf). 

# Installation


```{r, warning=FALSE, message=FALSE, eval=FALSE}
## check for devtools and install if necessary
if(!any(rownames(installed.packages()) == "devtools")) install.packages("devtools")
library(devtools)
install_github("PuttickMacroevolution/MCMCTreeR", quiet=TRUE)
```

The examples here use a phylogeny of apes and associated age information. These data are a phylogeny of apes ``apeTree``, the minimum ages for internal nodes ``minimumTimes``, maximum ages for internal nodes ``maximumTimes``, and the tip labels descending from each node ``monophyleticGroups``. These example data can be substituted for other data.

```{r}
library(MCMCTreeR)
data(apeData)
attach(apeData)
names(apeData)
```


# Estimate parameters for node input parameters

This section includes information to estimate and plot prior age distributions for node(s) used in MCMCtree divergence time estimation. The data required to do this is a phylogeny, minimum and maximum ages for the nodes with prior distributions, and taxa that descend from each node.

The code can be used to simultanaeouly estimate the parameter values that reflect the **a priori** time information for nodes and write files ready to be inpur in MCMCtree. MCMCTreeR can produce output files with the same type of distributions used to summarise **a prior** time information for all nodes, or seperate distributions can be used to reflect uncertainty on different internal nodes.

By default, the functions here estimates the distribution parameters so that the distribution spans for user-supplied minimum bounds (lower age) and maximum bounds (upper age). By default, minimum ages are treated as 'hard' constraints and maximum ages are 'soft'. The function then ensures that 97.5% of the distribution falls between these minimum and maximum ages. The code can estimate paramaters for the Cauchy, Skew-T, Skew-normal, and Gamma distirbutions shown in the [MCMCtree manual](http://abacus.gene.ucl.ac.uk/software/pamlDOC.pdf) on page 50. 

## Skew T

###	 estimate scale with a given shape

The deafult arguments in the ``estimateSkewT`` assumes the user wants to estimate the scale of the distribution with a given shape value (the default shape value is 50). The function estimates the parameters with the user-supplied minimum and maximum ages for all nodes, and the monophyletic groups that define the nodes.The output ``skewT_results$mcmctree`` shows the estimated parameters in the input ready for MCMCtree. Here the parameters for the Skew T distributions are the location (lower node age), scale, shape, and degrees of freedom

```{r}
skewT_results <- estimateSkewT(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, phy=apeTree, plot=FALSE)
skewT_results$mcmctree
```

The function ``plotMCMCTree`` plots the estimated age distributions given these parameters.

```{r, fig.align='center', fig.cap='Skew T distributions for all nodes', fig.height=6, fig.width=6}
par(mfrow=c(2,2), family="Palatino")
for(i in 1:4) plotMCMCTree(skewT_results$parameters[i,], method="skewT", title=paste0("node ", i), upperTime=max(maximumTimes))
skewT_results$mcmctree
```

If the distributions are acceptable, the output can be written into a tree file ready to be input into MCMCtree using the function ``estimateSkewT``. The functions will be written when the argument ``writeMCMCtree`` is set to ``TRUE``, and the file is set using the ``mcmcTreeName`` argument. Additionally, a PDF file is output showing the estimated distributions if ``plot=TRUE`` and the file name can be specifying using the argument ``pdfOutput``.

```{r}
# result in tree MCMCTree format
skewT_results$mcmctree
## not run
## skewT_results <- estimateSkewT(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, phy=apeTree, plot=FALSE, pdfOutput="skewTPlot.pdf", writeMCMCTree=TRUE, mcmcTreeName="skewTInput.tre")
```

It is not necessary to specify the same shape value for each parameter: a different value of the shape parameter can be set for each distribution.

```{r}
## not run (remove ## to run)
## skewT_results <- estimateSkewT(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, shape=c(9, 10, 8, 10), phy=apeTree, plot=TRUE, pdfOutput="skewTPlot.pdf", writeMCMCTree=TRUE, mcmcTreeName="skewTInput.tre")
## skewT_results$parameters
```

### estimate shape with a given scale

The function ``estimateSkewT`` will take input minimum input times, and estimate the value of the shape that will produce the desired distribution with the scale parameter set to 0.05.

```{r}
skewT_results <- estimateSkewT(minAge=minimumTimes[2], maxAge=maximumTimes[2], monoGroups=monophyleticGroups, scale=0.05, estimateShape=TRUE, estimateScale=FALSE, phy=apeTree, plot=FALSE, writeMCMCTree=FALSE)
skewT_results$parameters
```

##	 Skew normal

The ``estimateSkewNormal`` function estimates the value of the scale that will produce a skew normal distribution with the 97.5% cumulative probability of the distribution at the maximum age.

```{r}
skewNormal_results <- estimateSkewNormal(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, addMode=0.05, phy=apeTree, plot=FALSE)
skewNormal_results$parameters
```

As only a single value is provided for each parameter by the user, the function outputs warnings to indicate these values are recycled for each node. 

These skew normal distributions can be plotted to the screen.

```{r, fig.align='center', fig.cap='Skew normal distributions for all nodes', fig.height=6, fig.width=6}
par(mfrow=c(2,2), family="Palatino")
for(i in 1:4) plotMCMCTree(skewNormal_results$parameters[i,], method="skewNormal", title=paste0("node ", i), upperTime=max(maximumTimes))
```

##	Cauchy

Here the ``estimateCauchy`` function is used to estimate parameters and plot the example on page 50 of PAML manual.

```{r, fig.align='center', fig.cap='Cauchy distributions for all nodes  (with a given scale)', fig.height=6, fig.width=6}
example_page_50 <- estimateCauchy(minAge=1, maxAge=4.32, monoGroups=monophyleticGroups[[1]],   phy=apeTree,  offset=0.5, minProb=0.025, plot=FALSE)[[1]]
plotMCMCTree(example_page_50, method="cauchy", title=paste0("node ", i), upperTime=max(maximumTimes))
```

### estimate scale with a given shape 

The ``estimateCauch`` function will take input minimum input times, and estimate the value of the scale parameter that will produce a Cauchy distribution with the 97.5% cumulative probability of the distribution at the user-supplied maximum age.

```{r, fig.align='center', fig.cap='Cauchy distributions for all nodes (with a given shape)', fig.height=6, fig.width=6}
cauchy_results <- estimateCauchy(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups,  offset=0.5, phy=apeTree, plot=FALSE)
cauchy_results$parameters
par(mfrow=c(2,2), family="Times")
for(i in 1:4) plotMCMCTree(cauchy_results$parameters[i,], method="cauchy", title=paste0("node ", i), upperTime=max(maximumTimes))
```

These plots indicate we may have constrained our distribution too much for the 2nd, 3rd, and 4th distribution so we can modify that to allow for a smaller offset.

```{r, fig.align='center', fig.cap='Cauchy distributions for all nodes (with a given shape) and smaller offset', fig.height=6, fig.width=6}
cauchy_results <- estimateCauchy(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups,  offset=c(0.5, 0.1, 0.1, 0.05), phy=apeTree, plot=FALSE)
cauchy_results$parameters
par(mfrow=c(2,2), family="Times")
for(i in 1:4) plotMCMCTree(cauchy_results$parameters[i,], method="cauchy", title=paste0("node ", i), upperTime=maximumTimes[i])
```

## Uniform distribution

```{r, fig.align='center', fig.cap='Uniform distributions for all nodes', fig.height=6, fig.width=6}
uniform_results <- estimateBound(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, phy=apeTree, plot=FALSE)
uniform_results$parameters
par(mfrow=c(2,2), family="Palatino")
for(i in 1:4) plotMCMCTree(uniform_results$parameters[i,], method="bound", title=paste0("node ", i), upperTime=maximumTimes[i]+1)
```

##	 Gamma distribution

```{r, fig.align='center', fig.cap='Gamma distributions for all nodes', fig.height=6, fig.width=6}
gamma_results <- estimateGamma(minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, alpha=188, beta=2690, offset=0.1, phy=apeTree, plot=FALSE)
gamma_results$parameters
par(mfrow=c(2,2), family="Palatino")
for(i in 1:4) plotMCMCTree(gamma_results$parameters[i,], method="gamma", title=paste0("node ", i), upperTime=maximumTimes[i])
```

##	 Upper Age

```{r}
upper_results <- estimateUpper(maxAge=maximumTimes, monoGroups=monophyleticGroups, rightTail=0.025, phy=apeTree)
upper_results$parameters
```

##	Fixed ages

```{r}
fixed_results <- estimateFixed(minAge=minimumTimes[1], monoGroups=monophyleticGroups[[1]], phy=apeTree)
fixed_results 
```


##	 Different parameters on different nodes

If we want different parameters on different nodes we can specify this by using the ``mcmcTreePhy`` function. Here there are different distributions applied to the internal nodes: a fixed root (node 1), skew normal (node 2), gamma (node 3), and upper distribution (node 4) to our tree. For each input we give the associated parameter values in a vector in the order of nodes. i.e - for the ``min pro`` on four nodes can be set as 1, 2, 4 to be 1e-8 andnode 3 to be 0.025

```{r}
each.node.method <- c("skewT", "cauchy", "gamma", "upper")
output.full <- mcmcTreePhy(phy=apeTree, minAge=minimumTimes, maxAge=maximumTimes, monoGroups=monophyleticGroups, method=each.node.method, writeMCMCTree = FALSE)
```

This can fine-tuned. For example, to estimate alpha not beta for the 3rd node

```{r}
estimate.alpha <- c(FALSE, FALSE, TRUE, FALSE)
estimate.beta <- c(TRUE, TRUE, FALSE, TRUE)
outputFull <- mcmcTreePhy(phy=apeTree, minAges=minimumTimes, maxAges=maximumTimes, monoGroups=monophyleticGroups, method=each.node.method, estimateAlpha=estimate.alpha, estimateBeta=estimate.beta, alphaInput=188, betaInput=100, writeMCMCTree = FALSE)
```

Outputs from individual methods can be added to the input for subsequent node estimation. This allows for easier fine-tuning. Perhaps easier to explain with an example. Here, a skew normal is applied to the first node.

```{r}
skewNormal_results_nodeOne <- estimateSkewNormal(minAge=minimumTimes[1], maxAge=maximumTimes[1], monoGroups=monophyleticGroups[[1]], addMode=0.05, phy=apeTree, plot=FALSE, writeMCMCTree = FALSE)
skewNormal_results_nodeOne$apePhy
```

This output is then used as input in ``estimateCauchy`` to estimate parameters for a Cauchy distribution, which is applied to the second node.

```{r}
cauchy_results_nodeTwo <- estimateCauchy(minAge=minimumTimes[2], maxAge=maximumTimes[2], monoGroups=monophyleticGroups[[2]],  offset=0.5, phy=skewNormal_results_nodeOne$apePhy, plot=FALSE, writeMCMCTree = FALSE)
cauchy_results_nodeTwo$apePhy
```

The third node is the set as a uniform distribution.

```{r}
uniform_results_nodeThree <- estimateBound(minAge=minimumTimes[3], maxAge=maximumTimes[3], monoGroups=monophyleticGroups[[3]], phy=cauchy_results_nodeTwo$apePhy, plot=FALSE, writeMCMCTree = FALSE)
uniform_results_nodeThree$apePhy
```

The fourth is a skewT distribution, and the tree can be written to file for input into MCMCtree.

```{r}
## not run
# skewT_results_nodeFour <- estimateSkewT(minAge=minimumTimes[4], maxAge=maximumTimes[4], monoGroups=monophyleticGroups[[4]], scale=0.5, phy=cauchy_results_nodeTwo$apePhy, plot=FALSE, writeMCMCTree = TRUE)
# skewT_results_nodeFour$apePhy
```
